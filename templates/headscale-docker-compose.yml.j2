version: "3.9"
services:
  db:
    image: "postgres:14"
    restart: "unless-stopped"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/volumes/headscale/db:/var/lib/postgresql/data:rw"
    environment:
      - POSTGRES_PASSWORD={{ headscale_db_password }}
      - POSTGRES_USER=headscale
      - POSTGRES_DB=headscale
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "headscale"]
      interval: 10s
      timeout: 10s
      retries: 5
  app:
    image: "headscale/headscale:latest"
    restart: "unless-stopped"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/volumes/headscale/config:/etc/headscale:rw"
      - "/volumes/headscale/private.key:/etc/headscale/private.key:ro"
      - "/volumes/headscale/config.yaml:/etc/headscale/config.yaml:ro"
    command: headscale serve
    depends_on:
      db:
        condition: service_healthy
  proxy:
    image: "nginx:latest"
    restart: "unless-stopped"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/volumes/headscale/proxy/dhparams.pem:/etc/nginx/dhparams.pem:ro"
      - "/volumes/headscale/proxy/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "/volumes/headscale/proxy/privkey.pem:/etc/nginx/privkey.pem:ro"
      - "/volumes/headscale/proxy/fullchain.pem:/etc/nginx/fullchain.pem:ro"
      - "/volumes/headscale/proxy/chain.pem:/etc/nginx/chain.pem:ro"
      - "/volumes/headscale/proxy/cert.pem:/etc/nginx/cert.pem:ro"
    ports:
      - 1443:1443
    depends_on:
      - app
